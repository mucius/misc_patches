<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Misc patches by mucius</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Misc patches</h1>
        <p>Patches for ViewVC and Trac for using mixed Japanese encodings.</p>

        <p class="view"><a href="https://github.com/mucius/misc_patches">View the Project on GitHub <small>mucius/misc_patches</small></a></p>


        <ul>
          <li><a href="https://github.com/mucius/misc_patches/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/mucius/misc_patches/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/mucius/misc_patches">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1></h1>

<h1>
<a name="viewvc-" class="anchor" href="#viewvc-"><span class="octicon octicon-link"></span></a>viewvc の(ショートログ文字化け対策)パッチ</h1>

<h1></h1>

<h1>
<a name="-20110903" class="anchor" href="#-20110903"><span class="octicon octicon-link"></span></a>注意！ 以下のパッチは現在では必要ありません。詳細は、2011/09/03の追記をご覧ください</h1>

<h1></h1>

<h1>
<a name="-3" class="anchor" href="#-3"><span class="octicon octicon-link"></span></a>このパッチができること</h1>

<p>このパッチを当てることで、shift_jis, euc-jp, iso2022_jp, utf-8 が混在する
Subversionのリポジトリの文字化けが起きにくくなります．具体的には、</p>

<ol>
<li>use_localtime=1にしたときの(Windowsバージョンでの)ディレクトリ画面の時間表示とログ</li>
<li>view と blame 画面</li>
<li>シンタックスハイライトをOnにしときの view, blame画面</li>
<li>diff 画面</li>
</ol><p>での日本語の文字化けが改善されます．但し、side by side diff での日本語混在による
カラムずれの対策はまだです...</p>

<p>CVSのリポジトリに関しては未対策です．すいません...</p>

<p>下にも書いたのですが、ごく小さいファイルで文字コードがEUCかUTF-8の場合、
blameに失敗して、うまく変換できません。 blame の --force オプションに相当するものを
探してみたのですが、c のソースコードにある、svn_client_blame3() を使うための
svn_diff_file_options_t をpythonから使うことができていない為、あきらめモードです...
どなたか詳しい方、ご教示を... (ver.1.0.?では、コマンドラインのsvnをpipeで
使っているので、--forceを挿入済み)</p>

<ul>
<li><p>misc_patches/viewvc/1.1.0-beta/viewvc_all.patch は安定版用(ver.1.1.0-beta)('08/11/13追加 python2.5用)</p></li>
<li><p>misc_patches/viewvc/1.0.7/viewvc_all.patch は安定版用(ver.1.0.7)('08/11/04追加 python2.5用)</p></li>
<li><p>misc_patches/viewvc/1.0.5/viewvc_all.patch は安定版用(ver.1.0.5)('08/03/03追加,'08/11/13 python2.5用に修正)</p></li>
<li><p>misc_patches/viewvc/viewvc_all.patch がchardetを使用した開発版 ( rev.2047に対するパッチ．ver1.2-dev)</p></li>
<li><p>misc_patches/viewvc/viewvc_pykf_all.patch も開発版ですが、pykfを使用</p></li>
</ul><p>開発版で、pykf用のパッチを使う場合は、
misc_patches/pygments/lexer.patch (pygments用のパッチ)も必要です．</p>

<p>chardetは、<a href="http://chardet.feedparser.org">http://chardet.feedparser.org</a> にあります.</p>

<p>chardet用のパッチを当てた後で、やはり pykfにしたい場合は、
misc_patches/viewvc/forPykf/toutf8.py に置き換えて、 viewvc.py の "chardet" と書かれている
部分(2カ所あります)を全て"pykf"に書き換えることで、pykfが使えるようになります．</p>

<p>chardetを使わない場合は、pykf_ をインストールする必要があります． windows用のバイナリがあるのが嬉しいですね．</p>

<p>ああ，でも，ここのソースはヘッダファイルが足りないので，Linux等で使いたい人は</p>

<p><code>こちらの方</code>_ で提供されているtarballが良いようです．</p>

<p>.. _<code>こちらの方</code>: <a href="http://memo.jj-net.jp/231">http://memo.jj-net.jp/231</a></p>

<h1>
<a name="-4" class="anchor" href="#-4"><span class="octicon octicon-link"></span></a>注意</h1>

<p>このパッチは，ブラウザの表示関係については何もしていません．</p>

<p>httpd.conf等に</p>

<p>::</p>

<pre><code>AddDefaultCharset utf-8
</code></pre>

<p>と書いておけば文字化けしないはずですが，standalone.pyを使う場合は template/header/header.eztの</p>

<p>head部分に</p>

<p>::</p>

<p></p>

<p>と追加しておけばよいでしょう．</p>

<h2>
<a name="20110903" class="anchor" href="#20110903"><span class="octicon octicon-link"></span></a>追記(2011/09/03)</h2>

<p>３年ぶりにviewvcのリポジトリをチェックしてみたところ、本家の方でchardetをつかった
文字コード推定に対応していました。よかったよかった。
これは、ver.1.1.2から有効になっているようです。
ですので、trunkからの開発バージョンはもちろん、tarball/zipでダウンロードできる
ver.1.1.11でも可能となっています。
但し、デフォルトでは無効になっているので、viewvc.confで、</p>

<p>::</p>

<pre><code>detect_encoding = 1
</code></pre>

<p>とします。というわけで、ここのパッチはお役御免となったわけですが、</p>

<p>::</p>

<pre><code>short_log_len = 20
</code></pre>

<p>などとしていると、ログに日本語を使っている場合、日本語の途中で切ってしまうために
文字化けすることがあります。これに対策するためのパッチを作りました。</p>

<pre><code>* misc_patches/trunk/viewvc/viewvc.patch
</code></pre>

<p>エラーが無くなるまで、文末から1バイトづつ減らしてはデコードしてみるという
かなり強引な方法ですが...</p>

<h2>
<a name="-20081104" class="anchor" href="#-20081104"><span class="octicon octicon-link"></span></a>追記 (2008/11/04)</h2>

<ul>
<li><p>toutf8() を独立ファイルにしました。</p></li>
<li><p>python2.5に移行したので、コーデック名が前と違っています。2.4の場合は、以前のパッチを参考にして修正してください。</p></li>
<li><p>小さいファイルで、文字コードがeucか、utf-8の場合、blameに失敗するために、うまく変換できないことがあります。</p></li>
</ul><h2>
<a name="-2008219" class="anchor" href="#-2008219"><span class="octicon octicon-link"></span></a>追記 (2008/2/19)</h2>

<ul>
<li><p>mod_python用のファイル名が，viewvc.py から viewvc_mp.py のように変更になっています(!r1799)．</p></li>
<li><p>mod_python を ver.3.3.1 にすると，viewvcがエラーを吐くようです． <code>こちらの方が</code>_ 対策されています．</p></li>
</ul><p>.. _<code>こちらの方が</code>:  <a href="http://jfut.featia.net/diary/20070610.html">http://jfut.featia.net/diary/20070610.html</a></p>

<h2>
<a name="-200836" class="anchor" href="#-200836"><span class="octicon octicon-link"></span></a>追記 (2008/3/6)</h2>

<ul>
<li><p>リポジトリのディレクトリ構成を変更しました</p></li>
<li><p>リポジトリブラウザの最下部にある "ことなるフォーマットでダウンロード"からダウンロードすると、改行がLFのみになってしまうので、Windowsではパッチ当てに失敗するかもしれません。その時は改行記号を変えられるエディタでCR+LFに変更してみてください</p></li>
</ul><h2>
<a name="-2008319" class="anchor" href="#-2008319"><span class="octicon octicon-link"></span></a>追記 (2008/3/19)</h2>

<ul>
<li><p>以下のパッチは、 [<a href="http://e.tir.jp/wiliki/viewcvs">http://e.tir.jp/wiliki/viewcvs</a> こちらの方]  が作成されたviewvcvs用のものがオリジナルです。Tracのパッチも、そのパッチを借用した形になっています。 (Trac移動時に抜けてしまいました。ごめんなさい。)</p></li>
<li><p>y-miyoさんによる追加修正を反映しました(ver.1.0.5のみ)。</p></li>
</ul><h1></h1>

<h1>
<a name="trac-" class="anchor" href="#trac-"><span class="octicon octicon-link"></span></a>trac の(日本語文字コード混在環境向)パッチ</h1>

<p>このところWindowsのソフト開発でもコメントにUTF-8を使っていたので，
Tracのバージョンが上がって, パッチが無効になっていることに気づいていませんでした(!^_!^;;</p>

<p>そんなわけで，久々にパッチを更新しました．trac 0.10.4用ですが，きっと0.10.3でもいけるでしょう．</p>

<p>svn:mime-type をちゃんと設定してあげれば，このパッチは不要なのですが，
マルチな環境にまたがったプロジェクトだったりすると，文字コードが混在してしまって，
それをいちいちsvn:mim-typeで設定するのも大変かなあと．</p>

<p>もっとも，先にも書いたように，僕自身はWindowsでもLinuxでもutf-8でソースコードを
書くようになったので，それほど必要性を感じなくなってきたんですが...</p>

<ul>
<li>misc_patches/trunk/trac/api.patch は，trac/mimeview/api.py に対するパッチ，</li>
<li>misc_patches/trunk/trac/text.patch は， trac/utils/text.py に対するパッチです．</li>
</ul><p>pykf_ をインストールする必要があります．</p>

<h1>
<a name="-2010101" class="anchor" href="#-2010101"><span class="octicon octicon-link"></span></a>追記 (2010/10/1)</h1>

<p>またまた久々に、0.11 用と、0.12用のパッチを作成しました。</p>

<ul>
<li>misc_patches/trunk/trac/0.11/Trac-0.11.7.patch  が 0.11.7用</li>
<li>misc_patches/trunk/trac/0.12/Trac-0.12.patch が 0.12用です。</li>
</ul><p>今回からパッチを一つにまとめました。以下のようにあててください。</p>

<p>::</p>

<pre><code>% patch -p1 &lt; Trac-0.12.patch
</code></pre>

<p>.. _pykf: <a href="http://sourceforge.jp/projects/pykf/files/">http://sourceforge.jp/projects/pykf/files/</a></p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/mucius">mucius</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>