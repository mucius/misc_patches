diff -cr viewvc/lib/blame.py viewvc_n/lib/blame.py
*** viewvc/lib/blame.py	2007-04-18 06:38:33.674565000 +0900
--- viewvc_n/lib/blame.py	2008-02-19 00:17:02.912466200 +0900
***************
*** 35,40 ****
--- 35,41 ----
  import cgi
  import vclib
  import vclib.ccvs.blame
+ import viewvc
  
  
  re_includes = re.compile('\\#(\\s*)include(\\s*)"(.*?)"')
***************
*** 83,89 ****
      diff_url = None
      if item.prev_rev:
        diff_url = '%sr1=%s&amp;r2=%s' % (self.diff_url, item.prev_rev, item.rev)
!     thisline = link_includes(cgi.escape(item.text), self.repos,
                               self.path_parts, self.include_url)
      return _item(text=thisline, line_number=item.line_number,
                   rev=item.rev, prev_rev=item.prev_rev,
--- 84,90 ----
      diff_url = None
      if item.prev_rev:
        diff_url = '%sr1=%s&amp;r2=%s' % (self.diff_url, item.prev_rev, item.rev)
!     thisline = link_includes(cgi.escape( viewvc.toutf8(item.text)), self.repos,
                               self.path_parts, self.include_url)
      return _item(text=thisline, line_number=item.line_number,
                   rev=item.rev, prev_rev=item.prev_rev,
diff -cr viewvc/lib/viewvc.py viewvc_n/lib/viewvc.py
*** viewvc/lib/viewvc.py	2008-02-16 05:50:22.818138000 +0900
--- viewvc_n/lib/viewvc.py	2008-02-19 00:17:58.631216200 +0900
***************
*** 47,52 ****
--- 47,53 ----
  import vclib
  import vclib.ccvs
  import vclib.svn
+ import pykf
  
  try:
    import idiff
***************
*** 994,1002 ****
--- 995,1018 ----
                               '(#([-a-zA-Z0-9%.~:_]+)?)?)')
  _re_rewrite_email = re.compile('([-a-zA-Z0-9_.\+]+)@'
                                 '(([-a-zA-Z0-9]+\.)+[A-Za-z]{2,4})')
+ def toutf8(txt):
+   """pykf.guess cannot guess utf-8 string (wrong to sjis)"""
+   c = pykf.guess(txt)
+   if c is pykf.JIS:
+     u = unicode(txt, 'japanese.iso-2022-jp')
+     return u.encode('utf-8')
+   for enc in ['utf-8', 'japanese.euc-jp', 'japanese.shift_jis']:
+     try:
+       u = unicode(txt, enc)
+       return u.encode('utf-8')
+     except UnicodeError:
+       pass
+   return txt
+ 
  def htmlify(html, mangle_email_addrs=0):
    if not html:
      return html
+   html = toutf8(html)
    html = cgi.escape(html)
    html = re.sub(_re_rewrite_url, r'<a href="\1">\1</a>', html)
    if mangle_email_addrs:
***************
*** 1013,1030 ****
    return html
  
  def format_log(log, cfg, htmlize=1):
!   if not log:
!     return log
!   if htmlize:
!     s = htmlify(log[:cfg.options.short_log_len],
!                 cfg.options.mangle_email_addresses)
!   else:
!     s = cgi.escape(log[:cfg.options.short_log_len])
!     if cfg.options.mangle_email_addresses:
!       s = re.sub(_re_rewrite_email, r'\1@...', s)
!   if len(log) > cfg.options.short_log_len:
!     s = s + '...'
!   return s
  
  _time_desc = {
           1 : 'second',
--- 1029,1035 ----
    return html
  
  def format_log(log, cfg, htmlize=1):
!   return htmlify(log)
  
  _time_desc = {
           1 : 'second',
***************
*** 1438,1444 ****
      return None
    if cfg.options.use_localtime:
      localtime = time.localtime(date)
!     return time.asctime(localtime) + ' ' + time.tzname[localtime[8]]
    else:
      return time.asctime(time.gmtime(date)) + ' UTC'
  
--- 1443,1449 ----
      return None
    if cfg.options.use_localtime:
      localtime = time.localtime(date)
!     return time.asctime(localtime) + ' ' + toutf8( time.tzname[localtime[8]])
    else:
      return time.asctime(time.gmtime(date)) + ' UTC'
  
